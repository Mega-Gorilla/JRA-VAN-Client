# データ更新仕様書

## 1. 更新タイムテーブル

### 1.1 定期更新スケジュール

#### 平常時（土日開催）

| 曜日 | 時刻 | データ種別 | 内容 |
|------|------|-----------|------|
| 月曜 | 14:00 | RACE | 週末レース確定データ |
| 月曜 | 14:00 | HOSE | 競走馬マスタ更新 |
| 月曜 | 15:00 | DIFF | 次週番組確定 |
| 火曜 | 10:00 | YSCH | スケジュール更新 |
| 水曜 | 18:00 | SLOP | 坂路調教データ |
| 木曜 | 14:00 | HOSE | 出走登録馬更新 |
| 木曜 | 18:00 | SLOP | 坂路調教データ |
| 金曜 | 10:00 | DIFF | 出走馬確定 |
| 金曜 | 18:00 | MING | データマイニング予想 |
| 金曜 | 18:00 | SLOP | 坂路調教データ |
| 土曜 | 07:00 | 速報系 | リアルタイム開始 |
| 土曜 | 18:00 | MING | 日曜分予想 |
| 日曜 | 07:00 | 速報系 | リアルタイム開始 |

#### 3日間開催時

| 曜日 | 時刻 | データ種別 | 内容 |
|------|------|-----------|------|
| 月曜 | 14:00 | RACE | 3日間分確定データ |
| 火曜 | 14:00 | RACE | 月曜分追加 |
| 木曜 | 18:00 | MING | 金曜分予想 |
| 金曜 | 07:00 | 速報系 | リアルタイム開始 |

### 1.2 リアルタイム更新スケジュール

#### レース当日タイムライン

| 時刻 | データ | 説明 |
|------|--------|------|
| 07:00 | 0B12 | 単複オッズ配信開始 |
| 07:30 | 0B15 | 馬連オッズ配信開始 |
| 08:00 | 0B16,0B17 | ワイド・馬単オッズ開始 |
| 08:30 | 0B18 | 3連複オッズ開始 |
| 09:00 | 0B19 | 3連単オッズ開始 |
| 09:00 | 0B11 | 第1レース馬体重 |
| 10:00 | 0B30 | 第1レース確定 |
| 16:30 | 0B30 | 最終レース確定 |
| 17:00 | - | リアルタイム配信終了 |

## 2. データ更新ルール

### 2.1 データ優先順位

| 優先度 | データ区分 | レコード種別 | 説明 |
|--------|-----------|------------|------|
| 1 | 速報成績 | 3 | レース直後 |
| 2 | 確定成績 | 5 | 裁決確定後 |
| 3 | 月曜成績 | 7 | 月曜確定版 |
| 4 | 当週処理済み | 9 | 最終確定版 |
| 5 | 先週処理済み | A | アーカイブ |

### 2.2 データ上書きルール

```
新規データ受信
    ↓
データ区分確認
    ↓
既存データ有無
    ├─ なし → 新規追加
    └─ あり → 優先度比較
              ├─ 新データ優先度高 → 上書き
              └─ 既存データ優先度高 → スキップ
```

### 2.3 削除データ処理

| データ区分 | 処理 | 備考 |
|-----------|------|------|
| 2,4,6,8,0,B | 物理削除 | 該当レコード削除 |
| DIFF系 | 論理削除 | 削除フラグ設定 |

## 3. 更新頻度詳細

### 3.1 蓄積系データ

| データ種別 | 通常更新 | 最短間隔 | 最大遅延 |
|-----------|---------|---------|---------|
| RACE | 週1回（月曜） | 1週間 | 3日 |
| DIFF | 随時 | 1分 | なし |
| SLOP | 週3回 | 2日 | 1日 |
| YSCH | 年1回+随時 | 不定 | なし |
| HOSE | 週2回 | 3日 | 1日 |
| BLOD | 月1回 | 1ヶ月 | 1週間 |
| MING | レース前日 | 1日 | なし |

### 3.2 速報系データ

| データ種別 | 更新間隔 | 配信開始 | 配信終了 |
|-----------|---------|---------|---------|
| 0B11 | 1回のみ | 発走60分前 | - |
| 0B12 | 30秒 | 07:00 | 締切時 |
| 0B15 | 60秒 | 07:30 | 締切時 |
| 0B16 | 60秒 | 08:00 | 締切時 |
| 0B17 | 60秒 | 08:00 | 締切時 |
| 0B18 | 120秒 | 08:30 | 締切時 |
| 0B19 | 300秒 | 09:00 | 締切時 |
| 0B30 | 1回のみ | 確定直後 | - |
| 0B31 | 随時 | WIN5発売中 | 確定時 |

## 4. データ整合性管理

### 4.1 タイムスタンプ管理

| 項目 | 形式 | 用途 |
|------|------|------|
| ファイルタイムスタンプ | YYYYMMDDhhmmss | ファイル作成日時 |
| レコードタイムスタンプ | YYYYMMDDhhmmss | データ更新日時 |
| 最終更新タイムスタンプ | YYYYMMDDhhmmss | JVOpen基準時 |

### 4.2 バージョン管理

| レベル | 管理方法 | 更新契機 |
|--------|---------|---------|
| ファイル | ファイル名に日時 | ダウンロード時 |
| レコード | データ区分コード | 更新時 |
| フィールド | 変更フラグ | 項目変更時 |

## 5. 差分更新仕様

### 5.1 差分取得方法

```
前回最終タイムスタンプ = lastfiletimestamp
    ↓
JVOpen(dataspec, lastfiletimestamp, option)
    ↓
差分データのみ取得
```

### 5.2 差分更新対象

| データ種別 | 差分更新 | 全件更新 | 推奨 |
|-----------|---------|---------|------|
| RACE | ○ | ○ | 差分 |
| DIFF | ○ | × | 差分のみ |
| SLOP | ○ | ○ | 差分 |
| YSCH | × | ○ | 全件 |
| HOSE | ○ | ○ | 差分 |
| BLOD | × | ○ | 全件 |
| MING | ○ | × | 差分のみ |
| 速報系 | ○ | × | 差分のみ |

## 6. エラー時の更新処理

### 6.1 エラー種別と対応

| エラー | 原因 | リトライ | 代替処理 |
|--------|------|---------|---------|
| 通信エラー | ネットワーク障害 | 3回/5分間隔 | キャッシュ利用 |
| サーバーエラー | メンテナンス | 30分後 | 前回データ利用 |
| データ破損 | CRCエラー | 即時 | 再ダウンロード |
| タイムアウト | 過負荷 | 10分後 | 部分取得 |

### 6.2 リカバリー処理

```
エラー検出
    ↓
エラー種別判定
    ↓
リトライ可能？
    ├─ Yes → リトライ処理
    │         ├─ 成功 → 通常処理継続
    │         └─ 失敗 → エラー記録
    └─ No  → 代替処理
              ├─ キャッシュ確認
              └─ 部分データで継続
```

## 7. 特殊更新パターン

### 7.1 開催中止時

| フェーズ | 処理 | データ |
|---------|------|--------|
| 中止決定 | DIFF配信 | 中止情報 |
| 代替開催決定 | YSCH更新 | 新日程 |
| 代替番組確定 | RACE配信 | 新番組 |

### 7.2 番組変更時

| 変更種別 | 更新データ | タイミング |
|---------|-----------|---------|
| 出走取消 | DIFF(WC) | 即時 |
| 騎手変更 | DIFF(AV) | 即時 |
| 発走時刻変更 | DIFF(JC) | 決定後30分以内 |
| コース変更 | DIFF(CC) | 決定後即時 |

### 7.3 重賞レース

| タイミング | 追加データ | 説明 |
|---------|-----------|------|
| 登録時 | TOKU | 特別登録馬 |
| 2週前 | SLOP強化 | 調教データ増 |
| 前日 | MING詳細 | 予想データ充実 |

## 8. データ保持期間

### 8.1 サーバー側保持期間

| データ種別 | 保持期間 | 削除タイミング |
|-----------|---------|------------|
| RACE | 永続 | なし |
| DIFF | 3ヶ月 | 四半期 |
| SLOP | 1ヶ月 | 月次 |
| 速報系 | 1週間 | 週次 |

### 8.2 クライアント側推奨保持期間

| データ種別 | 推奨期間 | 理由 |
|-----------|---------|------|
| RACE | 永続 | 分析用 |
| DIFF | 1週間 | 参照頻度低 |
| SLOP | 2週間 | 直近のみ有用 |
| 速報系 | 3日 | リアルタイムのみ |

## 9. 更新通知仕様

### 9.1 更新検知方法

| 方法 | 間隔 | 対象 |
|------|------|------|
| ポーリング | 5分 | 速報系 |
| スケジュール | 定時 | 蓄積系 |
| プッシュ | - | 未対応 |

### 9.2 更新通知パラメータ

```
JVOpen実行
    ↓
dlcount > 0 ?
    ├─ Yes → 新規データあり
    │         ├─ ダウンロード開始
    │         └─ 更新通知発行
    └─ No  → 新規データなし
              └─ 次回チェックまで待機
```

## 10. パフォーマンス指標

### 10.1 更新処理時間目標

| 処理 | データ量 | 目標時間 |
|------|---------|---------|
| 差分確認 | - | 3秒以内 |
| 1レース分DL | 約1MB | 1秒以内 |
| 1日分DL | 約50MB | 30秒以内 |
| 1週間分DL | 約200MB | 2分以内 |

### 10.2 並行更新制限

| 項目 | 制限値 | 備考 |
|------|--------|------|
| 同時接続数 | 1 | JVLink制限 |
| 同時処理レコード数 | 1 | 順次処理 |
| バッファサイズ | 110KB | 固定 |

---

*最終更新: 2025年8月29日*  
*バージョン: 4.9.0.2*