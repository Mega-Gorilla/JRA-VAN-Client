# JRA-VAN データ仕様書

## 目次

1. [概要](#概要)
2. [データ体系](#データ体系)
3. [データ種別詳細](#データ種別詳細)
4. [レコードフォーマット](#レコードフォーマット)
5. [データ識別と構造](#データ識別と構造)
6. [更新タイミング](#更新タイミング)
7. [コードマスタ](#コードマスタ)
8. [データ利用上の注意](#データ利用上の注意)

---

## 概要

JRA-VAN Data Lab.は、日本中央競馬会（JRA）が提供する競馬データ配信サービスです。
本仕様書は、JRA-VAN SDK Ver4.9.0.2に基づくデータフォーマットと利用方法を定義します。

### 特徴

- **リアルタイム配信**: レース当日のオッズ、馬体重等をリアルタイムで提供
- **蓄積系データ**: 過去30年以上の競馬データを網羅
- **固定長フォーマット**: すべてのデータは固定長のテキスト形式
- **文字コード**: Shift-JIS（CP932）エンコーディング

### システム要件

- **動作環境**: Windows 10/11（32ビットアプリケーション）
- **必須コンポーネント**: JVLink（JVDTLAB.dll）
- **データサイズ**: 初回セットアップ時 約10GB以上

---

## データ体系

JRA-VANのデータは大きく2つのカテゴリに分類されます。

### 1. 蓄積系データ

過去のレース情報や競走馬情報など、確定済みのデータ群です。

| データ種別 | 識別子 | 説明 | 主要レコード | 更新頻度 |
|-----------|--------|------|-------------|----------|
| RACE | RA | レース詳細情報 | RA（レース詳細） | 週次（月曜） |
| DIFF | DF | 番組変更情報 | RA（変更後情報） | 随時 |
| SNAP | SN | 現時点情報 | - | 随時 |
| SLOP | SL | 坂路調教情報 | HC（調教本追切） | 週次 |
| YSCH | YS | 年間スケジュール | YS（開催情報） | 年次/随時 |
| HOSE | UM | 競走馬マスタ | UM（馬基本情報） | 週次 |
| HOYU | HY | 抹消馬・繁殖馬 | HY（繁殖馬情報） | 月次 |
| COMM | CS | コメントマスタ | CS（コメント） | 週次 |
| MING | DM | データマイニング予想 | DM（予想データ） | レース前日 |

### 2. 速報系データ（リアルタイム）

レース当日に配信される最新情報です。

| データ種別 | 識別子 | 説明 | 配信タイミング |
|-----------|--------|------|--------------|
| 0B11 | WH | 馬体重 | 発走60分前 |
| 0B12 | O1 | 単勝・複勝オッズ | 30秒間隔 |
| 0B13 | O2 | 馬連オッズ | 1分間隔 |
| 0B14 | O3 | ワイドオッズ | 1分間隔 |
| 0B15 | O4 | 馬単オッズ | 1分間隔 |
| 0B16 | O5 | 3連複オッズ | 2分間隔 |
| 0B17 | O6 | 3連単オッズ | 5分間隔 |
| 0B20 | H1 | 単勝・複勝票数 | 10分間隔 |
| 0B30 | HR | 払戻金 | 確定後即時 |
| 0B31 | WF | WIN5情報 | 随時 |

---

## データ種別詳細

### RACE - レース詳細情報

最も基本的なデータで、各レースの詳細情報を含みます。

#### 含まれる情報
- レース基本情報（日時、場所、条件）
- 出走馬情報（馬名、騎手、調教師）
- レース結果（着順、タイム、着差）
- 払戻金情報

#### レコード構成
```
RA - レースヘッダ (409 bytes)
SE - 馬毎レース情報 (555 bytes × 出走頭数)
HR - 払戻情報 (可変長)
```

#### データ取得例
```python
# データスペック: RACE
# オプション: 1（通常データ）
# 期間: 20250801-20250831
dataspec = "RACE"
option = 1
from_time = "20250801000000"
to_time = "20250831235959"
```

### 0B12 - 単勝・複勝オッズ

リアルタイムで更新される単勝・複勝のオッズ情報です。

#### 特徴
- **更新間隔**: 30秒
- **提供時間**: 発売開始～締切
- **データ量**: 1レースあたり約2KB

#### データ構造
```
O1 - オッズヘッダ (41 bytes)
  - 単勝オッズ (各馬 5 bytes × 28頭)
  - 複勝オッズ (最低/最高 各5 bytes × 28頭)
```

---

## レコードフォーマット

### 基本構造

すべてのレコードは以下の基本構造を持ちます：

```
[レコード種別ID(2)] [データ部(可変)] [改行(2)]
```

- **レコード種別ID**: 2バイトの英数字（例: "RA", "SE", "O1"）
- **データ部**: レコード種別により異なる固定長データ
- **改行**: CR+LF（0x0D0A）

### データ型

| 型 | 説明 | 例 | 備考 |
|---|------|-----|------|
| 9 | 数字 | "123" | 右詰め、ゼロパディング |
| X | 文字 | "ウマナリ" | 全角は2バイト |
| S9 | 符号付き数値 | "+123" | 先頭1バイトが符号 |
| YYYYMMDD | 日付 | "20250829" | 8バイト固定 |
| HHMMSS | 時刻 | "153045" | 6バイト固定 |

### レコード例: RA（レース詳細）

```
位置  バイト  項目名              型      内容
----  ------  ----------------  ------  ------------------------
1     2       レコード種別        X(2)    "RA"固定
3     16      レースID           
3     4       開催年             9(4)    西暦4桁
7     4       開催月日           9(4)    MMDD形式
11    2       競馬場コード        X(2)    "01"=札幌～"10"=小倉
13    2       開催回             X(2)    第N回
15    2       開催日目           X(2)    N日目
17    2       レース番号         X(2)    "01"～"12"
19    390     レース情報         
409   2       改行               X(2)    CR+LF
```

---

## データ識別と構造

### レースID体系

レースを一意に識別する16バイトのキー：

```
YYYY MMDD JJ KK NN RR
│    │    │  │  │  └─ レース番号 (01-12)
│    │    │  │  └──── 日目 (01-12)
│    │    │  └─────── 回次 (01-09)
│    │    └──────────── 場コード (01-10)
│    └───────────────── 月日 (MMDD)
└────────────────────── 年 (YYYY)

例: 2025082905030911 = 2025年8月29日札幌3回9日11R
```

### 馬識別体系

競走馬を識別する10バイトの血統登録番号：

```
YYYY NNNNNN
│    └─────── 登録連番 (000001-999999)
└──────────── 生年 (西暦4桁)

例: 2020102345 = 2020年生まれ、登録番号102345
```

---

## 更新タイミング

### 蓄積系データ

| データ | 通常更新 | 臨時更新 | 備考 |
|--------|---------|---------|------|
| RACE | 月曜 14:00 | - | 週末レース確定後 |
| DIFF | - | 随時 | 番組変更発生時 |
| MING | 金曜 18:00 | 土曜 18:00 | レース前日 |
| HOSE | 月曜 14:00 | 木曜 14:00 | 出走登録後 |

### 速報系データ

| 時間帯 | 配信データ | 更新間隔 |
|--------|-----------|---------|
| 7:00～ | 0B12（単複オッズ） | 30秒 |
| 8:00～ | 0B15（馬連オッズ） | 60秒 |
| 発走60分前 | 0B11（馬体重） | 1回のみ |
| 確定後 | 0B30（払戻） | 即時 |

---

## コードマスタ

### 競馬場コード

| コード | 競馬場名 | 地区 | 芝/ダート |
|--------|---------|------|----------|
| 01 | 札幌 | 北海道 | 両方 |
| 02 | 函館 | 北海道 | 両方 |
| 03 | 福島 | 東北 | 両方 |
| 04 | 新潟 | 関東 | 両方 |
| 05 | 東京 | 関東 | 両方 |
| 06 | 中山 | 関東 | 両方 |
| 07 | 中京 | 東海 | 両方 |
| 08 | 京都 | 関西 | 両方 |
| 09 | 阪神 | 関西 | 両方 |
| 10 | 小倉 | 九州 | 両方 |

### グレードコード

| コード | グレード | 説明 | 例 |
|--------|---------|------|-----|
| A | GⅠ | 最高格付け | 日本ダービー、有馬記念 |
| B | GⅡ | 準重賞 | 弥生賞、京都記念 |
| C | GⅢ | 重賞 | 共同通信杯、根岸S |
| D | 重賞以外のOP | オープン特別 | 東京新聞杯 |
| E | L（リステッド） | 準オープン | - |
| F | 3勝クラス | 条件戦 | 1600万下 |
| G | 2勝クラス | 条件戦 | 1000万下 |
| H | 1勝クラス | 条件戦 | 500万下 |
| I | 新馬 | デビュー戦 | - |
| J | 未勝利 | 未勝利戦 | - |

### 性別コード

| コード | 性別 | 説明 |
|--------|------|------|
| 1 | 牡 | 牡馬 |
| 2 | 牝 | 牝馬 |
| 3 | セ | セン馬（去勢馬） |

### 馬記号コード

| コード | 記号 | 意味 |
|--------|------|------|
| 01 | ○外 | 外国産馬 |
| 02 | □地 | 地方馬 |
| 03 | △外□地 | 外国産地方馬 |
| 04 | ○市 | 市場取引馬 |
| 05 | ○権 | 限定中止後の出走権利保有馬 |
| 06 | ○父 | 父内国産馬 |
| 07 | ○市○父 | 市場取引馬かつ父内国産馬 |
| 08 | ○抽 | 抽選馬 |
| 09 | ○父○抽 | 父内国産馬かつ抽選馬 |
| 10 | ○市○抽 | 市場取引馬かつ抽選馬 |
| 11 | ○父○市○抽 | 3条件すべて該当 |
| 15 | ○指 | 指定馬 |
| 16 | ○特指 | 特別指定馬 |
| 17 | ○国際 | 国際馬 |
| 18 | ♀ | 牝馬限定出走可能牡・セン馬 |
| 19 | ○地○父 | 地方馬かつ父内国産馬 |
| 20 | ○地○市 | 地方馬かつ市場取引馬 |
| 21 | ○地○父○市 | 地方馬かつ父内国産馬かつ市場取引馬 |
| 22 | ○父（英） | 父内国産馬（英国産馬） |
| 23 | ○父（愛） | 父内国産馬（愛国産馬） |
| 24 | ○父（仏） | 父内国産馬（仏国産馬） |
| 25 | ○父（伊） | 父内国産馬（伊国産馬） |
| 26 | ○父（独） | 父内国産馬（独国産馬） |
| 27 | ○父（米） | 父内国産馬（米国産馬） |

### 異常区分コード

| コード | 区分 | 説明 |
|--------|------|------|
| 1 | 取消 | 出走取消 |
| 2 | 除外 | 発走除外 |
| 3 | 中止 | 競走中止 |
| 4 | 失格 | 失格 |
| 5 | 降着 | 降着 |
| 6 | 再騎乗 | 再騎乗 |

---

## データ利用上の注意

### 文字コード処理

JRA-VANのデータはShift-JIS（CP932）でエンコードされています。

```python
# Python での読み込み例
with open('jvdata.txt', 'r', encoding='cp932') as f:
    data = f.read()

# バイトデータとして処理する場合
data_bytes = data.encode('cp932')
```

### 全角半角の扱い

- **馬名**: 全角カタカナ9文字（18バイト）
- **騎手名**: 全角8文字（16バイト）
- **数値**: 半角数字
- **スペース**: 全角スペース（0x8140）でパディング

### NULL値の表現

データが存在しない場合の表現方法：

| データ型 | NULL表現 | 例 |
|----------|---------|-----|
| 数値 | ゼロまたはスペース | "00000" or "     " |
| 文字列 | スペースパディング | "　　　　　" |
| 日付 | "00000000" | 未確定日 |
| 時刻 | "000000" | 未確定時刻 |

### タイム表記

競走タイムは1/10秒単位で記録されます。

```
"0593" = 59.3秒 = 0分59秒3
"1234" = 123.4秒 = 2分03秒4
```

### 金額表記

金額は円単位で右詰め、ゼロパディングされます。

```
"00001234500" = 1,234,500円
"00000000100" = 100円
```

### データ更新の重複

同一レコードが複数回配信される場合があります。
最新のタイムスタンプを持つレコードを正とします。

### エラー処理

```python
def parse_jv_data(data: bytes) -> dict:
    """JVデータのパース"""
    try:
        # レコード種別の確認
        record_type = data[0:2].decode('cp932')
        
        # レコード種別に応じた処理
        if record_type == 'RA':
            return parse_race_header(data)
        elif record_type == 'SE':
            return parse_race_uma(data)
        else:
            raise ValueError(f"Unknown record type: {record_type}")
            
    except UnicodeDecodeError as e:
        # 文字コードエラー
        logger.error(f"Decode error: {e}")
        return None
    except Exception as e:
        # その他のエラー
        logger.error(f"Parse error: {e}")
        return None
```

### パフォーマンス考慮事項

1. **大量データ処理**
   - バッチ処理での取得を推奨
   - 1回の取得で100MB以上になる可能性

2. **メモリ管理**
   - ストリーミング処理の実装
   - 必要なデータのみパース

3. **キャッシュ戦略**
   - 確定データは永続化
   - リアルタイムデータは有効期限設定

### ライセンスと利用規約

JRA-VANデータの利用には以下の制限があります：

1. **商用利用**: JRAとの契約が必要
2. **再配布**: 原則禁止
3. **改変**: データの改変は禁止
4. **表示義務**: データ提供元の明記が必要
5. **更新義務**: 最新データの利用を推奨

---

## 付録

### サンプルコード

#### データ取得
```python
from jravan import JVLinkManager

# マネージャー初期化
manager = JVLinkManager()
manager.init("UMANARI1.0")

# データ取得
with manager.open("RACE", "20250801000000", 1) as reader:
    for record in reader:
        if record.type == "RA":
            print(f"レース: {record.race_info.hondai}")
        elif record.type == "SE":
            print(f"馬: {record.uma_info.bamei}")
```

#### オッズ監視
```python
import asyncio
from jravan import RealtimeClient

async def monitor_odds():
    client = RealtimeClient()
    await client.connect()
    
    async for odds in client.watch_odds("202508290511"):
        print(f"単勝1番人気: {odds.win[0].odds}")
        
asyncio.run(monitor_odds())
```

### トラブルシューティング

| エラーコード | 説明 | 対処法 |
|-------------|------|--------|
| -111 | 初期化されていない | JVInit実行 |
| -201 | オープン済み | JVClose後に再実行 |
| -301 | パラメータエラー | 引数を確認 |
| -401 | ファイルがない | データダウンロード |
| -501 | サーバーエラー | 時間をおいて再試行 |

### 関連資料

- [JRA-VAN Data Lab. 公式サイト](https://jra-van.jp/)
- [JVLink SDK ドキュメント](https://jra-van.jp/dlb/sdv/sdk.html)
- [データ仕様書 PDF版](https://jra-van.jp/dlb/sdv/doc/JV-Data_Spec.pdf)

---

*最終更新: 2025年8月29日*
*バージョン: 4.9.0.2*